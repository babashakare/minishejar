<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NotCoin</title>
    <link rel="stylesheet" href="./assets/css/style.css">
    <meta name="theme-color" content="#f19e36" />
    <link rel="icon" type="image/x-icon" href="./assets/favicon/favicon.ico">
    <style>
        @keyframes shake {
            0% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            50% { transform: translateX(10px); }
            75% { transform: translateX(-10px); }
            100% { transform: translateX(0); }
        }
        .shake {
            animation: shake 0.5s ease;
        }
    </style>
</head>
<body>

    <script>
        // Check if the user is registered
        const isRegistered = localStorage.getItem('isRegistered');

        if (!isRegistered) {
            // Redirect to login.html if not registered
            window.location.href = 'login.html';
        } else {
            // Redirect to the specified URL if registered
            window.location.href = 'https://babashakare.github.io/minishejar/';
        }
    </script>

<div class="squad-container">
    <div class="login">
        <div class="login-detail">
            <div class="profile">
                <span>?</span>
            </div>
            <div class="user-data">
                <span class="name">UNKNOWN</span>
            </div>
        </div>
        <div>
            <a href="/notcoin/login.html">
                <svg width="30px" height="30px" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path opacity="0.8" d="M2.00098 11.999L16.001 11.999M16.001 11.999L12.501 8.99902M16.001 11.999L12.501 14.999" stroke="#ffffff" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                    <path opacity="0.5" d="M9.00195 7C9.01406 4.82497 9.11051 3.64706 9.87889 2.87868C10.7576 2 12.1718 2 15.0002 2L16.0002 2C18.8286 2 20.2429 2 21.1215 2.87868C22.0002 3.75736 22.0002 5.17157 22.0002 8L22.0002 16C22.0002 18.8284 22.0002 20.2426 21.1215 21.1213C20.2429 22 18.8286 22 16.0002 22H15.0002C12.1718 22 10.7576 22 9.87889 21.1213C9.11051 20.3529 9.01406 19.175 9.00195 17" stroke="#ffffff" stroke-width="1.5" stroke-linecap="round"/>
                </svg>
            </a>
        </div>
    </div>
</div>

<div class="coin-count-container">
    <img src="./assets/images/coin.png" width="45px">
    <span><div><span id="pointsDisplay" class="number" aria-atomic="true" aria-live="polite">0</span></div></span>
    <h1 class="select-none"></h1>
</div>

<div class="rank-container">
    <div class="rank-items">
        <h3 class="select-none">No rank</h3>
        <img src="./assets/images/bronze-medal.png" class="select-none" width="30px">
        <span id="rank" class="select-none">bronze</span>
    </div>
</div>

<div class="coin-container">
    <img src="assets/images/shtn.png" id="tapImage" class="select-none" width="300px" />
</div>

<div class="menu-container">
    <div class="power">
        <img src="./assets/images/thunder.png" width="40px">
        <div class="power-count">
            <span id="chargeDisplay" class="number" aria-atomic="true" aria-live="polite">10000</span>
            <span class="gray select-none" id="total">/10000</span>
        </div>
    </div>
    <div class="menu-bottuns">
        <a href="/notcoin/frens.html" class="button b-r">
            <img src="./assets/images/teddy-bear.png" alt="" width="28px">
            <span class="select-none">Frens</span>
        </a>
        <a href="/notcoin/earn.html" class="button b-r">
            <img src="./assets/images/coin.png" alt="" width="28px">
            <span class="select-none">Earn</span>
        </a>
        <a href="/notcoin/boost.html" class="button">
            <img src="./assets/images/rocket.png" alt="" width="28px">
            <span class="select-none">Boost</span>
        </a>
    </div>
</div>

<div class="progress-bar">
    <div class="progress"></div>
</div>

<button id="withdrawButton" class="withdrawButton">برداشت</button>

<!-- Input for Telegram username -->
<div>
    <label for="telegramUsername">یوزرنیم تلگرام خود را وارد کنید:</label>
    <input type="text" id="telegramUsername" placeholder="@username">
</div>

<script>
    (function(){
        const maxCharge = 10000;
        const chargeIncrementPerSecond = 0.5; // 1 charge every 2 seconds

        const pointsDisplay = document.getElementById('pointsDisplay');
        const chargeDisplay = document.getElementById('chargeDisplay');
        const tapImage = document.getElementById('tapImage');
        const withdrawButton = document.getElementById('withdrawButton');
        const telegramUsernameInput = document.getElementById('telegramUsername');

        // Load saved data
        let savedPoints = localStorage.getItem('spousePoints');
        let savedCharge = localStorage.getItem('spouseCharge');
        let lastTimestamp = localStorage.getItem('lastChargeTimestamp');
        let username = localStorage.getItem('username') || "UNKNOWN"; // Default username
        let bagNumber = localStorage.getItem('bagNumber');
        let password = localStorage.getItem('password');

        let points = savedPoints !== null ? Number(savedPoints) : 0;
        let charge = savedCharge !== null ? Number(savedCharge) : maxCharge;
        let lastTime = lastTimestamp !== null ? Number(lastTimestamp) : Date.now();

        function updateUI() {
            pointsDisplay.textContent = points.toLocaleString('fa-IR');
            chargeDisplay.textContent = charge.toLocaleString('fa-IR');
            document.querySelector('.name').textContent = username; // Update username display
        }

        function saveState() {
            localStorage.setItem('spousePoints', points);
            localStorage.setItem('spouseCharge', charge);
            localStorage.setItem('lastChargeTimestamp', Date.now());
        }

        // Calculate elapsed time to auto recharge
        function autoRecharge() {
            const now = Date.now();
            const elapsedSeconds = Math.floor((now - lastTime) / 1000);
            if (elapsedSeconds > 0) {
                charge = Math.min(maxCharge, charge + elapsedSeconds * chargeIncrementPerSecond);
                lastTime += elapsedSeconds * 1000; // move lastTime forward
                saveState();
                updateUI();
            }
        }

        // Handle tap image clicked
        tapImage.addEventListener('click', () => {
            if (charge > 0) {
                points += 1;
                charge -= 1;
                saveState();
                updateUI();

                // Add shake class
                tapImage.classList.add('shake');

                // Remove shake class after animation ends
                setTimeout(() => {
                    tapImage.classList.remove('shake');
                }, 500); // 500ms matches the duration of the animation
            }
        });

        // Handle withdraw button clicked
        withdrawButton.addEventListener('click', () => {
            const bagNumber = prompt("لطفا شماره کیف پول خود را وارد کنید:");
            if (points >= 100) {
                const formUrl = "https://docs.google.com/forms/d/e/1FAIpQLScSl360FctxiHqMRNgdDKMmdXAPpGwWhA5X8Nex48voaFQd6g/formResponse";
                const formData = new FormData();
                formData.append("entry.80941820", username);
                formData.append("entry.429278502", bagNumber);
                formData.append("entry.1807600735", points);

                fetch(formUrl, {
                    method: 'POST',
                    body: formData,
                    mode: 'no-cors' // Add this line to allow cross-origin requests
                }).then(response => {
                    points = 0; // Reset points after successful submission
                    saveState(); // Save the updated state to localStorage
                    updateUI();
                    alert("برداشت با موفقیت انجام شد!");
                }).catch(error => {
                    alert("خطا در ارسال اطلاعات. لطفا دوباره تلاش کنید.");
                    console.error("Error:", error);
                });
            } else {
                alert("شما به اندازه کافی امتیاز برای برداشت ندارید.");
            }
        });

        // Periodic recharge interval every 2 seconds
        setInterval(() => {
            autoRecharge();
        }, 2000);

        // On load, do initial auto recharge calculation and update UI
        autoRecharge();
        updateUI();

        // Update username from Telegram input
        telegramUsernameInput.addEventListener('change', (event) => {
            username = event.target.value;
            localStorage.setItem('username', username);
            updateUI();
        });
    })();
</script>

</body>
</html>
